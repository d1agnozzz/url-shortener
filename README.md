
# url-shortener

Сервис для сокращения URL.

```
├── cmd
│   └── main.go // точка входа
├── docker-compose.yml
├── Dockerfile
├── go.mod
├── go.sum
└── internal
    ├── aliaser // генератор алиасов, коротких ссылок
    │   ├── aliaser.go
    │   ├── aliaser_test.go
    │   ├── charset.go
    │   └── charset_test.go
    ├── api
    │   └── api.go
    ├── storage //
    │   ├── inmemory.go
    │   ├── inmemory_test.go
    │   ├── postgres.go
    │   └── storage.go
    ├── types
    │   └── types.go
    └── urlsanitizer // санитайзер адресов URL (нормализатор + валидатор)
        ├── sanitizer.go
        └── sanitizer_test.go
```

## Возможности

- Создание короткой ссылка через POST

    > request Body: { "url" : "your_desired_url.com" }
    > response Body: { "alias" : "vbrh10gm6_" }

- Получение оригинальной ссылки по раннее полученому алиасу

    > GET request localhost:8080/vjrm693f_6
    > response Body: { "url" : "youtube.com" }


## Особенности

- Каждая ссылка, сохраняемая в хранилище нормализуется (`URLSanitizer`) для дедупликации
    - принимаются только URL со схемой протокола http/https, без портов
    - разрешается сохранять ссылки с query parameters, при сохранении параетры сортируются по алфавиту, чтобы избежать дупликатов от перестановок
- Алиас генеруется на основе хеша MD5 с дальнейшей кодировкой в строку установленой длины с установленным алфавитом
- Для смены режимов хранилица объявлен и реализован интерфейс `Storage`
    - Хранилище в памяти приложения реализовано через хэш-мапу `map[string]types.URLMapping`, в качестве ключа используется алиас, а в качестве значения -- строка таблицы. Для хранилища в памяти настроена работа с мьютексом для синхронизации доступа к данным из разных корутин.
	- Режим хранилища определяется по значение переменной окружения `STORAGE_TYPE`
    - База даных состоит из таблицы url_aliases, формирующаяся следующим запросом:
```
CREATE TABLE IF NOT EXISTS url_aliases (
                id BIGINT GENERATED BY DEFAULT AS IDENTITY,
                url TEXT NOT NULL CHECK (LENGTH(url) <= 2000),
                alias TEXT NOT NULL CHECK (LENGTH(alias) <= 10),
                created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
                CONSTRAINT unique_url UNIQUE (url),
                CONSTRAINT unique_alias UNIQUE (alias)
)

```
* При получении очередного URL, поиск в хранилище осуществляется не по самой строке URL, которая может быть достаточно длинная, а по сгенерированному алиасу. Если запись с таким алиасом находится в таблице, сверяются данный и записанный в хранилище URL адреса. Если адреса одинаковые, значит такой адрес уже был записан, вставка не производится, возвращается алиас. Если адреса разные, значит произошла коллизия. **Для решения колизий** строки перед хешированием "солятся" путем дописывания в конце строки числа попытки поиска нужного URL. Количество попыток ограничено по умолчанию 5ю, по истечении попыток сервис возвращает ошибку.
